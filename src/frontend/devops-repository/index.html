<!DOCTYPE html>
<html>
    <head>
        <meta charset=UTF-8>
        <meta name=viewport content="width=device-width,initial-scale=1">
        <meta http-equiv=X-UA-Compatible content="ie=edge">
        <meta http-equiv="Pragma" content="no-cache" />
        <title>Devops制品库管理</title>
    </head>
<body>
    <div id="app"></div>
    <script src="<%= htmlWebpackPlugin.options.VENDOR_LIBS%>"></script>
    <script>
        var AJAX_URL_PREFIX = '__BKREPO_HTTP_SCHEMA__://__BK_REPO_FQDN__/web'
        var DEVOPS_SITE_URL = '__BK_HTTP_SCHEMA__://__BK_CI_FQDN__'
        var LOGIN_SERVICE_URL = '__BK_HTTP_SCHEMA__://__BK_REPO_PAAS_LOGIN_URL__/'
        // standalone: 独立部署模式
        // ci: ci模式
        var MODE_CONFIG = '__BK_REPO_DEPLOY_MODE__' || 'standalone'
    </script>
    <script>
        const redirectUrl = location.href.split(/\?redirect=/)[1]

        window.getLoginUrl = function () {
            const loginUrl = new URL(LOGIN_SERVICE_URL)
            const cUrl = location.origin + (redirectUrl ? (redirectUrl + '?preview=true') : '')
            loginUrl.searchParams.append('c_url', cUrl)
            return loginUrl.href
        }

        if (redirectUrl) {
            document.body.removeChild(document.querySelector('#app'))
            const xhr = new XMLHttpRequest()
            xhr.onreadystatechange = function (e) {
                const { readyState, status } = e.currentTarget
                if (readyState === 4 && status === 200) {
                    location.href = location.origin + redirectUrl + '?preview=true'
                } else if (status === 401) {
                    location.href = window.getLoginUrl(location.origin + redirectUrl + '?preview=true')
                }
            }
            xhr.withCredentials = true
            xhr.open('HEAD', redirectUrl)
            xhr.send()
        }
    </script>
</body>
